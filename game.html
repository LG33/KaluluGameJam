<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
    <title>Kalulu Game Jam</title>
	<script type="text/javascript" src="js/phaser.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

var game = new Phaser.Game(2424, 1536, Phaser.AUTO, '', { preload: preload, create: create, update: update });

function preload() {

    game.load.image('background', 'assets/background.png');
    //game.load.image('ground', 'assets/platform.png');
    game.load.image('button2', 'assets/poi.png');
    game.load.image('button1', 'assets/cosse.png');
    game.load.image('button0', 'assets/grappe.png');
    game.load.image('truck', 'assets/truck.png');
    /*game.load.spritesheet('itemDragged', 'assets/dude.png', 32, 48);
    game.load.spritesheet('dude', 'assets/dude.png', 32, 48);*/

}

var buttons;
var itemDragged;

var spriteButtons = new Array();
var dragItems = new Array();
var positions = [{x: 360, y: 1020}, {x: 700, y: 550}, {x: 250, y: 410}];

var truck;

var order;
var orderText, timerText, countText;
var orderNbr = [2, 1, 3], count = [0, 0, 0];
var eachSecond;
var timer = 30;

var orders;

var score = 0;
var scoreText;

var itemDraggedIndex = -1;

function create() {
    //  A simple background for our game
    game.add.sprite(0, 0, 'background');

		order = game.add.group();

		//var orders = new array();
		truck = game.add.sprite(580, 20, 'truck');

    orderText = game.add.text(700, 30, '000', { fontSize: '20px', fill: '#000' });
		timerText = game.add.text(700, 60, '30s', { fontSize: '20px', fill: '#000' });
		eachSecond = game.time.create(false);
		eachSecond.loop(1000, decreaseTimer, this);
    countText = game.add.text(700, 90, '000', { fontSize: '20px', fill: '#000' });

		createNewOrder();

    buttons = game.add.group();
		itemsDragged = game.add.group();

		for(var i=0; i<3; i++){
			var button = buttons.create(positions[i].x, positions[i].y, 'button' + i);
			spriteButtons.push(button);
			var dragItem = itemsDragged.create(positions[i].x, positions[i].y, 'button' + i);
			dragItem.alpha = 0;
			dragItem.inputEnabled = true;
			dragItem.input.enableDrag();
	    dragItem.events.onDragStart.add(onDragStart, this);
	    dragItem.events.onDragStop.add(onDragStop, this);
			dragItems.push(dragItem);
		}

    //  The score
    scoreText = game.add.text(16, 16, 'Score : 0', { fontSize: '32px', fill: '#000' });

    //  Our controls.
    mouse = game.input.keyboard.createCursorKeys();
}

function createNewOrder(){
	/*var newOrder = {
		orderNbr: [2, 1, 1],
		orderText: game.add.text(700, 30, orderNbr[0] + "" + orderNbr[1] + "" + orderNbr[2], { fontSize: '20px', fill: '#000' }),
		time: 30,
		timerText: game.add.text(700, 60, time + "s", { fontSize: '20px', fill: '#000' }),
		count: [0, 0, 0],
		countText: game.add.text(700, 90, count[0] + "" + count[1] + "" + count[2], { fontSize: '20px', fill: '#000' }),
	}
	orders.push(newOrder);*/
	updateOrderNbr(getRandomInt(0, 2), getRandomInt(0, 7), getRandomInt(0, 7));
	updateTimer(30);
	eachSecond.start();
	updateAllCount(0, 0, 0);
}

function update() {

}

function updateOrderNbr(poi, cosse, grappe){
	orderNbr = [poi, cosse, grappe];
	orderText.text = orderNbr[0] + "" + orderNbr[1] + "" + orderNbr[2];
}

function decreaseTimer() {
	updateTimer(timer-1);
	if(timer == 0){
		resetOrder();
		addScore(-10);
	}
}
function updateTimer(newValue){
	timer = newValue;
	timerText.text = timer + "s";
}

function addCount(index){
	if(count[index] < 9)
		count[index]++;
	else {
		count[index] = 0;
		if(index > 0)
			count[index-1]++;
	}
	updateCountText();
}
function updateAllCount(poi, cosse, grappe){
	count = [poi, cosse, grappe];
	updateCountText();
}
function updateCountText(){
	countText.text = count[0] + "" + count[1] + "" + count[2];
}

function onDragStart (sprite, pointer) {
	sprite.alpha = 1;
}
function onDragStop (sprite, pointer) {
	var index = 0;
	for(var i=0; i<3; i++){
		if(sprite == dragItems[i]){
			index = i;
		}
	}

	if(checkOverlap(truck, sprite)){
		addCount(index);
		updateCountText();
		sprite.alpha = 0;

		checkOrderComplete();
	}
	else{

	}
	sprite.x = positions[index].x;
	sprite.y = positions[index].y;
}

function checkOrderComplete(){
	for(var i=0; i<3; i++){
		if(count[i] != orderNbr[i])
			return;
	}
	addScore(10);
	resetOrder();
}

function addScore (newValue) {
	score += newValue;
	scoreText.text = "Score : " + score;
}

function resetOrder(){
	eachSecond.stop(false);
	createNewOrder();
}

function checkOverlap(spriteA, spriteB) {
    var boundsA = spriteA.getBounds();
    var boundsB = spriteB.getBounds();

    return Phaser.Rectangle.intersects(boundsA, boundsB);
}

function getRandomInt(min, max) {
  min = Math.ceil(min);
  max = Math.floor(max);
  return Math.floor(Math.random() * (max - min)) + min;
}

</script>

</body>
</html>
