<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
    <title>Kalulu Game Jam</title>
	<script type="text/javascript" src="js/phaser.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

var game = new Phaser.Game(800, 600, Phaser.AUTO, '', { preload: preload, create: create, update: update });

function preload() {

    game.load.image('sky', 'assets/sky.png');
    game.load.image('ground', 'assets/platform.png');
    game.load.image('poi', 'assets/poi.png');
    game.load.image('cosse', 'assets/cosse.png');
    game.load.image('grappe', 'assets/grappe.png');
    game.load.image('truck', 'assets/truck.png');
    game.load.spritesheet('itemDragged', 'assets/dude.png', 32, 48);
    game.load.spritesheet('dude', 'assets/dude.png', 32, 48);

}

var buttons;
var poiButton, cosseButton, grapButton;
var poiDrag, cosseDrag, grapDrag;
var itemDragged;

var truck;

var order;
var orderText, timer, countText;
var orderNbr = 213, timer = 30, count = 0;

var stars;
var score = 0;
var scoreText;

var itemDraggedIndex = -1;

function create() {
    //  A simple background for our game
    game.add.sprite(0, 0, 'sky');

		order = game.add.group();

		//var orders = new array();
		truck = game.add.sprite(580, 200, 'truck');

    orderText = game.add.text(700, 30, orderNbr.toString(), { fontSize: '20px', fill: '#000' });
    timer = game.add.text(700, 60, '30s', { fontSize: '20px', fill: '#000' });
    countText = game.add.text(700, 90, '000', { fontSize: '20px', fill: '#000' });

    buttons = game.add.group();
		itemsDragged = game.add.group();
		itemsDragged.inputEnableChildren = true;

		poiButton = buttons.create(20, 100, 'poi');
		poiDrag = itemsDragged.create(20, 100, 'poi');
		poiDrag.alpha = 0;
		poiDrag.inputEnabled = true;
		poiDrag.input.enableDrag();
    poiDrag.events.onDragStart.add(onDragStart, this);
    poiDrag.events.onDragStop.add(onDragStop, this);

		cosseButton = buttons.create(20, 150, 'cosse');
		cosseDrag = itemsDragged.create(20, 150, 'cosse');
		cosseDrag.alpha = 0;
		cosseDrag.inputEnabled = true;
		cosseDrag.input.enableDrag();
    cosseDrag.events.onDragStart.add(onDragStart, this);
    cosseDrag.events.onDragStop.add(onDragStop, this);

		grapButton = buttons.create(20, 200, 'grappe');
		grapDrag = itemsDragged.create(20, 200, 'grappe');
		grapDrag.alpha = 0;
		grapDrag.inputEnabled = true;
		grapDrag.input.enableDrag();
    grapDrag.events.onDragStart.add(onDragStart, this);
    grapDrag.events.onDragStop.add(onDragStop, this);

    //  The score
    scoreText = game.add.text(16, 16, 'Score : 0', { fontSize: '32px', fill: '#000' });

    //  Our controls.
    mouse = game.input.keyboard.createCursorKeys();
}

function update() {

}

function onDragStart (sprite, pointer) {
	sprite.alpha = 1;
}
function onDragStop (sprite, pointer) {
	if(checkOverlap(truck, sprite)){
		sprite.x = 20;
		switch (sprite) {
			case poiDrag:
				changeOrderCount(1);
				sprite.y = 100;
				break;
			case cosseDrag:
				changeOrderCount(10);
				sprite.y = 150;
				break;
			case grapDrag:
				changeOrderCount(100);
				sprite.y = 200;
				break;
			default:
				break;
		}
		sprite.alpha = 0;
	}
	else{

	}
}

function changeOrderCount (newValue) {
	count += newValue;
	countText.text = count.toString();

	if(count == orderNbr){
		addScore(10);
	}
}
function addScore (newValue) {
	score += newValue;
	scoreText.text = "Score : " + score;
}

function checkOverlap(spriteA, spriteB) {
    var boundsA = spriteA.getBounds();
    var boundsB = spriteB.getBounds();

    return Phaser.Rectangle.intersects(boundsA, boundsB);
}

</script>

</body>
</html>
